## SMT 首件核对工具 - 技术说明 & 架构设计

### 1. 整体架构概览

- **UI 层（视图）**：`app.py` + `ui/sidebar.py` + `ui/main_content.py`  
  - 负责页面布局、文件上传、配置表单、结果展示与报告下载  
- **业务逻辑层（领域）**：`src/logic.py`  
  - 实现 BOM 表与站位表的比对算法，如一料多站聚合、替代料处理、位号集合运算、反向检测等  
- **数据访问 / 工具层（基础设施）**：`src/data_loader.py`、`src/utils.py`、`src/user_manager.py`  
  - 负责 Excel 解析、文本与编号归一化、配置与用户数据的读写  
- **配置与样式**：`config/settings.py`、`config/mappings.py`、`config/styles.py`  
  - 定义页面配置、分隔符正则、规格提取正则、字段别名映射，以及统一的 UI 视觉样式  

这种分层结构有利于将「业务规则」和「UI 展现」解耦，便于后期替换前端技术或对接到其它系统。

---

### 2. 核心数据流

1. **文件上传与预处理**
   - 用户在侧边栏上传 BOM 与 Station 文件，Streamlit 提供 `UploadedFile` 对象
   - `ui/main_content.render_main_area()` 调用 `src.data_loader.load_excel_secure()` 将其转换为 `pandas.DataFrame`

2. **字段映射配置**
   - 项目通过 `config/mappings.ALIAS_CONFIG` 定义列名别名，例如：
     - BOM 料号：`["编号", "料号", "Part", "PN", "Material", "物料编码"]`
     - 站位表位号：`["位置号1", "图样", "位号", "Ref", "Designator", "图样名", "位置号"]`
   - 实际运行过程中，以 `system_data.json` 为持久层，支持在「管理员后台」中动态维护这些别名  
   - 在比对时，`ui/main_content` 使用 `guess_column_index` / `guess_column_names` 根据别名在 DataFrame 列中自动找出最佳匹配并提供给用户修正

3. **比对运算**
   - 完成列映射后，由 `run_smt_comparison(df_bom, df_station, config_map, ignore_nc)` 作为主入口执行对比
   - 比对结果以 List[dict] 的形式返回到 UI 层，用于表格展示和 Excel 报告导出

---

### 3. Excel 安全加载与表头自动识别（`src/data_loader.py`）

#### 3.1 Excel 解析策略

`load_excel_secure(file)` 采用 **两级兜底** 策略：

1. **优先使用 `pandas`**
   - 根据文件扩展名选择合适的 engine：
     - `.csv` → `pd.read_csv(..., header=None)`
     - `.xlsx` → `pd.read_excel(..., engine="openpyxl", header=None)`
     - `.xls` → `pd.read_excel(..., engine="xlrd", header=None)`
   - 读取失败时记录异常（`pandas_error`），并尝试下一步

2. **回退到 `xlwings` + Excel COM**
   - 为保证兼容复杂格式、宏、合并单元格等场景，在安装了 Microsoft Excel 的现场环境下调用 `xlwings.App` 打开工作簿
   - 使用 `sheet.used_range.options(numbers=str).value` 直接拉取单元格值为二维列表，再交由 `_materialize_dataframe` 进行结构化

整个函数通过 `@st.cache_data(ttl=CACHE_TTL)` 做结果缓存，在首件核对的典型场景中可显著降低重复解析大表的时间开销。

#### 3.2 表头自动检测与清洗

关键流程：

- `_detect_header_row(df)`  
  - 遍历行，使用 `HEADER_CANDIDATES` 和关键字段（如「安装号码」「元件名」等）判断哪一行是表头行  
  - 支持多种厂内表头风格，减少模板依赖

- `_materialize_dataframe(df)`  
  - 去掉全空列、全空行  
  - 以检测到的 header 行作为列名，并使用 `deduplicate_headers` 为重复列添加 `.1`、`.2` 后缀，避免 `pandas` 的列长度冲突  
  - 将特定字符串（`"None"`, `"nan"`, `"<NA>"`）标准化为空字符串，减少脏值影响

这一模块体现了对 **非标准 Excel 模板** 的兼容能力，是制造现场系统的核心难点之一。

---

### 4. 位号与料号归一化（`src/utils.py`）

实际业务中，BOM、站位表和系统导出之间的格式并不统一，典型问题包括：

- 料号被 Excel 自动识别为科学计数法（如 `3.00E+13`）  
- 位号中包含连字符、空格、斜杠等非标准字符（如 `LED-1`、`R 10`）  

为解决这些问题，项目中实现了以下工具函数：

- `clean_text(text)`  
  - 统一转大写、去掉制表符与零宽字符，减少比较时的误差

- `normalize_pn_value(value)`  
  - 尝试将字符串转为浮点数；当内容含有 `E` 或 `.` 时视为科学计数法，转回整数字符串  
  - 对无法解析为数字的内容则按原字符串逻辑清洗

- `normalize_ref_designator(ref)`  
  - 利用正则去掉所有非字母数字字符，实现 `LED-1` → `LED1`、`C 10` → `C10`  

- `parse_refs(ref_str, pattern)` / `parse_subs(sub_str, pattern)`  
  - 使用统一的分隔符正则（`SPLIT_PATTERN`）解析位号与替代料列表

这些函数在比对逻辑中多次复用，确保系统对输入格式具有较强鲁棒性。

---

### 5. BOM vs Station 比对逻辑（`src/logic.py`）

#### 5.1 聚合与预处理

1. **站位表聚合**
   - 通过 `station_map[pn] = {'refs': set(), 'slots': [], 'desc': ..., 'rows': [...]}` 结构聚合每个料号的所有位号、安装号和备注
   - 支持：
     - 多列位号：利用 `c_s_ref` 为 list 的方式，将多列位号拼接进一个字符串后再解析
     - 过滤内部说明行和重复表头（检测关键关键词与「VERSION」等标识）

2. **BOM 聚合**
   - 类似地构建 `bom_aggregated[bom_pn] = {'refs': set(), 'subs': set(), 'desc': ..., 'rows': [...]}`  
   - 对指定列解析替代料（`parse_subs`），用于后续主料/替代料统一比较

#### 5.2 正向比对（从 BOM 出发）

对每一个 BOM 料号：

- 计算候选物料集合 `targets = [主料] + 替代料列表`  
- 在 `station_map` 中收集所有匹配到的站位信息（位号集合、安装号、备注）  
- 通过 **规范化位号集合** 进行集合运算：
  - `missing = BOM 位号集合 - 实装位号集合`  
  - `extra   = 实装位号集合 - BOM 位号集合`

根据结果输出不同级别的记录：

- **缺料**：完全找不到主料及替代料 → `🔴 严重`  
- **位号不符**：存在 `missing` 或 `extra` → `🟠 警告`，并在差异说明中给出具体位号列表  
- **规格不匹配预警**：使用 `check_spec_conflict` 对比 BOM 描述与站位备注中提取的封装/耐压等参数 → `🟠 警告`  
- **通过**：位号完全匹配，且无规格冲突 → `🟢 正常`

#### 5.3 反向检测（从站位表出发）

在正向比对结束后，统计所有被 BOM 声明并已成功匹配的站位料号集合 `claimed_st_pns`，再对比：

- `set(station_map.keys()) - claimed_st_pns`  
  - 这部分视为 BOM 中未声明的「多余料 / 错料」，输出 `🔴 严重` 记录  

#### 5.4 通用比对类 `SMTComparator`

同时，文件中还实现了一个更通用的类 `SMTComparator`，可以在不依赖 `DataFrame` 的情况下，对两组结构化列表数据进行同样的比较。

接口设计：

- 输入为 List[dict] 形式的 `BOM_Data` 与 `Station_Data`  
- 返回值为统一的结果结构，字段包含 `level`, `code`, `message`, `context`  

这一抽象为将来对接 MES/ERP 或 REST API 提供了良好的扩展点。

---

### 6. 配置与用户数据管理（`src/user_manager.py`）

系统采用简单的 JSON 文件 `system_data.json` 存储：

- 检验员列表 `inspectors`
- 管理员密码 `admin_password`
- 列名映射配置 `mappings`

主要函数：

- `load_data()` / `save_data(data)`：统一读写逻辑，并在缺失关键字段时自动补齐默认值  
- `get_inspector_list()` / `add_inspector()` / `delete_inspector()`：提供与 UI 解耦的检验员管理接口  
- `verify_admin()` / `update_admin_password()`：实现管理员密码的验证和修改  
- `get_mappings()` / `update_mappings()` / `reset_mappings()`：封装别名映射的获取与更新，并保证与默认配置的兼容性

设计要点：

- 通过简单 JSON 而不是数据库，降低部署复杂度，适合现场单机工具场景  
- 在数据损坏或缺失时尽可能恢复默认值，避免因配置文件错误导致系统无法启动  

---

### 7. UI 与交互设计（`ui/*`、`config/styles.py`）

#### 7.1 页面布局

- `app.py` 中设置 `st.set_page_config(layout="wide")` 并通过 `st.columns([2.5, 7.5])` 实现左窄右宽布局：
  - 左侧：文件上传、参数说明、管理员后台  
  - 右侧：操作流程 / 映射配置 / 结果展示 / 报表导出  

- 顶部横幅 `BANNER_HTML` 展示系统名称与版本，增强专业感

#### 7.2 自定义样式

`config/styles.CUSTOM_CSS` 对 Streamlit 默认布局做了定制，包括：

- 去除默认顶部 header 和 footer，突出业务内容  
- 设置统一字体和容器间距，适应大屏显示  
- 自定义按钮样式、卡片背景色（如 BOM / Station 配置区域的颜色区分）

---

### 8. 报表导出与可追溯性

报表导出逻辑集中在 `ui/main_content.render_main_area()` 中：

- 使用 `pandas.ExcelWriter` + `xlsxwriter`：
  - Sheet1：`核对结果`，在第 3 行后写入汇总表，将「级别」列设置条件格式（红/橙/绿）  
  - Sheet2：`原BOM表`，完整保存导入的 BOM  
  - Sheet3：`原站位表`，完整保存导入的站位表  

- 顶部写入工单信息：
  - 订单号、订单数量、核对时间、检验人  
  - 为字段名和数据分别应用不同的单元格格式，以提升可读性

- 使用 `ws.protect('admin', protect_opts)` 对 Sheet 进行保护，防止误改核心字段，同时保留筛选与排序功能

`src/utils.py` 中预留的 `get_machine_info()` 和 `generate_signature()` 可用于将后续扩展：

- 在报表中写入设备信息与数据签名，用于防篡改和责任追溯  

---

### 9. 可扩展性与未来规划

基于当前设计，可以较为容易地扩展：

- **接入数据库 / MES**：将 `system_data.json` 替换为数据库持久层；或直接在比对前后写入 MES 记录  
- **支持多机种批量比对**：在 `SMTComparator` 的基础上加入批量任务调度  
- **REST API / 前后端分离**：将 `src/logic.py` 封装为 API 服务，对接前端或移动端  
- **规则引擎化**：将规格预警、NC 规则抽象为可配置规则集，支持现场人员图形化配置  

这些演进方向可以在面试时作为「未来规划」进行阐述，展示你对系统生命周期和可演进性的思考。

